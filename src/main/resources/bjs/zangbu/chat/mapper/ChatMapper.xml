<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bjs.zangbu.chat.mapper.ChatMapper">

    <!-- 메시지 전송 시 db에 메시지 저장 -->
    <insert id="insertMessage">
        INSERT INTO chat_message (chat_room_id, member_id, message, created_at)
        VALUES (#{chatRoomId}, #{senderId}, #{message}, NOW())
        <selectKey resultType="Long" keyProperty="chatMessageId" keyColumn="chat_message_id" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!-- roomId를 기준으로 메시지들 가져오기 -->
    <select id="selectMessagesByRoomId" resultType="bjs.zangbu.chat.vo.ChatMessage">
        SELECT chat_message_id, chat_room_id, user_id, message, created_at
        FROM chat_message
        WHERE chat_room_id = #{chatRoomId}
        <!-- lastMessageId가 있으면 그 Id보다 작은 메시지들만 limit개씩 가져오기 : 페이징 -->
        <if test="lastMessageId != null">
            AND chat_message_id &lt; #{lastMessageId}
        </if>
        ORDER BY chat_message_id DESC
        LIMIT #{limit}
    </select>

    <!-- roomId를 기준으로 채팅방 상세 정보 가져오기 -->
    <select id="selectChatRoomById" resultType="bjs.zangbu.chat.vo.ChatRoom">
        SELECT chat_room_id, building_id, member_id,
               seller_nickname, consumer_nickname
        FROM chat_room
        WHERE chat_room_id = #{chatRoomId}
    </select>


    <!-- 사용자의 채팅방 목록 조회 -->
    <select id="selectChatRoomList" resultType="bjs.zangbu.chat.vo.ChatRoom">
        SELECT chat_room_id, building_id, member_id,
               seller_nickname, consumer_nickname
        FROM chat_room
        WHERE member_id = #{userId}
    </select>




    <!-- 채팅방 유무 확인(중복 생성 방지) -->
    <select id="existsChatRoom" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM chat_room WHERE building_id = #{buildingId} AND member_id = #{userId}
        )
    </select>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom">
        INSERT INTO chat_room (chat_room_id, building_id, member_id, seller_nickname, consumer_nickname)
        VALUES (#{chatRoomId}, #{buildingId}, #{userId}, #{sellerNickname}, #{consumerNickname})
    </insert>

    <!-- roomId에 해당하는 채팅방의 메시지들 모두 삭제(채팅방 삭제 전 메시지 먼저 삭제) -->
    <delete id="deleteMessagesByRoomId">
        DELETE FROM chat_message
        WHERE chat_room_id = #{chatRoomId}
    </delete>

    <!-- 채팅방 삭제 (해당 채팅방의 메시지들 삭제 우선되어야함: deleteMessagesByRoomId.)-->
    <delete id="deleteChatRoom">
        DELETE FROM chat_room WHERE chat_room_id = #{chatRoomId}
    </delete>

</mapper>
