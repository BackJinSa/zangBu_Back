<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bjs.zangbu.documentReport.mapper.DocumentViewStateMapper">

    <resultMap id="DVSMap" type="bjs.zangbu.documentReport.vo.DocumentViewState">
        <id column="member_id" property="memberId"/>
        <id column="building_id" property="buildingId"/>
        <id column="doc_type" property="docType"/>
        <result column="viewed_at" property="viewedAt"/>
    </resultMap>

    <insert id="upsert">
        INSERT INTO document_view_state (member_id, building_id, doc_type, viewed_at)
        VALUES (#{memberId}, #{buildingId}, #{docType}, NOW()) ON DUPLICATE KEY
        UPDATE viewed_at = NOW()
    </insert>

    <select id="countViewedBoth" resultType="int">
        SELECT COUNT(DISTINCT doc_type) AS cnt
        FROM document_view_state
        WHERE member_id = #{memberId}
          AND building_id = #{buildingId}
          AND doc_type IN ('ESTATE', 'BUILDING_REGISTER')
    </select>

    <select id="findOne" resultMap="DVSMap">
        SELECT *
        FROM document_view_state
        WHERE member_id = #{memberId}
          AND building_id = #{buildingId}
          AND doc_type = #{docType}
    </select>

</mapper>
