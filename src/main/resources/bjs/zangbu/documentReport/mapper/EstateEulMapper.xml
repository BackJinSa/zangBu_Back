<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bjs.zangbu.documentReport.mapper.EstateEulMapper">

    <resultMap id="EstateEulMap" type="bjs.zangbu.documentReport.vo.EstateEul">
        <id column="id" property="id"/>
        <result column="building_id" property="buildingId"/>
        <result column="rank_no" property="rankNo"/>
        <result column="rank_order" property="rankOrder"/>
        <result column="purpose" property="purpose"/>
        <result column="receipt" property="receipt"/>
        <result column="cause" property="cause"/>
        <result column="creditor" property="creditor"/>
        <result column="debtor" property="debtor"/>
        <result column="max_claim_amount" property="maxClaimAmount"/>
        <result column="remarks_raw" property="remarksRaw"/>
        <result column="building_only" property="buildingOnly"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <select id="findByBuildingId" parameterType="long" resultMap="EstateEulMap">
        SELECT *
        FROM estate_eul
        WHERE building_id = #{buildingId}
        ORDER BY CASE WHEN rank_order IS NULL THEN 1 ELSE 0 END,
                 rank_order ASC, id ASC
    </select>

    <delete id="deleteByBuildingId" parameterType="long">
        DELETE
        FROM estate_eul
        WHERE building_id = #{buildingId}
    </delete>

    <insert id="batchInsert">
        INSERT INTO estate_eul (
        building_id, rank_no, rank_order, purpose, receipt, cause,
        creditor, debtor, max_claim_amount, remarks_raw, building_only, created_at
        )
        VALUES
        <foreach collection="list" item="e" separator=",">
            (
            #{e.buildingId}, #{e.rankNo}, #{e.rankOrder}, #{e.purpose}, #{e.receipt}, #{e.cause},
            #{e.creditor}, #{e.debtor}, #{e.maxClaimAmount}, #{e.remarksRaw}, #{e.buildingOnly}, NOW()
            )
        </foreach>
    </insert>

    <select id="findFirstEncumbrance" parameterType="long" resultMap="EstateEulMap">
        SELECT *
        FROM estate_eul
        WHERE building_id = #{buildingId}
        ORDER BY CASE WHEN rank_order IS NULL THEN 1 ELSE 0 END,
                 rank_order ASC, id ASC LIMIT 1
    </select>

</mapper>
