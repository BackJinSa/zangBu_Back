<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bjs.zangbu.review.mapper.ReviewMapper">

    <select id="selectByBuilding" resultType="bjs.zangbu.review.dto.response.ReviewListResponse">
        SELECT
            review_id         AS reviewId,
            reviewer_nickname AS reviewerNickname,
            rank,
            DATE_FORMAT(created_at, '%Y-%m-%dT%H:%i:%s') AS createdAt
        FROM review
        WHERE building_id = #{buildingId}
        ORDER BY created_at DESC
    </select>

    <select id="countByBuilding" resultType="long">
        SELECT COUNT(*)
        FROM review
        WHERE building_id = #{buildingId}
    </select>

    <!-- 추가된 selectLatestReviewRank -->
    <select id="selectLatestReviewRank" resultType="int">
        SELECT rank
        FROM review
        WHERE building_id = #{buildingId}
        ORDER BY created_at DESC
            LIMIT 1
    </select>


    <!-- 리뷰 상세보기 기능 쿼리 -->
    <select id="selectById"
            resultType="bjs.zangbu.review.dto.response.ReviewDetailResponse">
        SELECT
            review_id          AS reviewId,
            building_id        AS buildingId,
            address_id         AS addressId,
            reviewer_nickname  AS reviewerNickname,
            rank,
            content,
            DATE_FORMAT(created_at, '%Y-%m-%dT%H:%i:%s') AS createdAt
        FROM review
        WHERE review_id = #{reviewId}
    </select>


    <!-- 리뷰 생성(insertReview) -->
    <insert id="insertReview"
            parameterType="bjs.zangbu.review.mapper.ReviewInsertParam"
            useGeneratedKeys="true"
            keyProperty="reviewId">
        INSERT INTO review
        (building_id,
         user_id,
         address_id,
         reviewer_nickname,
         rank,
         content,
         created_at)
        VALUES
            (#{buildingId},
             #{userId},
             #{addressId},
             #{reviewerNickname},
             #{rank},
             #{content},
             NOW())
    </insert>


    <!-- 리뷰 삭제 -->
    <delete id="deleteReview" parameterType="long">
        DELETE FROM review
        WHERE review_id = #{reviewId}
    </delete>
</mapper>
